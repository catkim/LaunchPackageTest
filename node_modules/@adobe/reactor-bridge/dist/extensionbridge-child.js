/***************************************************************************************
 * (c) 2017 Adobe. All rights reserved.
 * This file is licensed to you under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License. You may obtain a copy
 * of the License at http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under
 * the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
 * OF ANY KIND, either express or implied. See the License for the specific language
 * governing permissions and limitations under the License.
 ****************************************************************************************/(function(){'use strict';function a(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function b(b){for(var c=1;c<arguments.length;c++){var d=null==arguments[c]?{}:arguments[c],e=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(e=e.concat(Object.getOwnPropertySymbols(d).filter(function(a){return Object.getOwnPropertyDescriptor(d,a).enumerable}))),e.forEach(function(c){a(b,c,d[c])})}return b}function c(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function d(a,b){return b={exports:{}},a(b,b.exports),b.exports}var e=d(function(a,b){Object.defineProperty(b,"__esModule",{value:!0}),b.DATA_CLONE_ERROR=b.MESSAGE=b.REJECTED=b.FULFILLED=b.REPLY=b.CALL=b.HANDSHAKE_REPLY=b.HANDSHAKE=void 0;b.HANDSHAKE="handshake";b.HANDSHAKE_REPLY="handshake-reply";b.CALL="call";b.REPLY="reply";b.FULFILLED="fulfilled";b.REJECTED="rejected";b.MESSAGE="message";b.DATA_CLONE_ERROR="DataCloneError"});c(e);var f=e.DATA_CLONE_ERROR,g=e.MESSAGE,h=e.REJECTED,i=e.FULFILLED,j=e.REPLY,k=e.CALL,l=e.HANDSHAKE_REPLY,m=e.HANDSHAKE,n=d(function(a,b){Object.defineProperty(b,"__esModule",{value:!0}),b.ERR_NO_IFRAME_SRC=b.ERR_NOT_IN_IFRAME=b.ERR_CONNECTION_TIMEOUT=b.ERR_CONNECTION_DESTROYED=void 0;b.ERR_CONNECTION_DESTROYED="ConnectionDestroyed";b.ERR_CONNECTION_TIMEOUT="ConnectionTimeout";b.ERR_NOT_IN_IFRAME="NotInIframe";b.ERR_NO_IFRAME_SRC="NoIframeSrc"});c(n);var o=n.ERR_NO_IFRAME_SRC,p=n.ERR_NOT_IN_IFRAME,q=n.ERR_CONNECTION_TIMEOUT,r=n.ERR_CONNECTION_DESTROYED,s=d(function(a,b){Object.defineProperty(b,"__esModule",{value:!0}),b.default=void 0;b.default=()=>{const a=[];let b=!1;return{destroy(){b=!0,a.forEach(a=>{a()})},onDestroy(c){b?c():a.push(c)}}},a.exports=b.default});c(s);var t=d(function(a,b){Object.defineProperty(b,"__esModule",{value:!0}),b.deserializeError=b.serializeError=void 0;b.serializeError=a=>{let b=a.name,c=a.message,d=a.stack;return{name:b,message:c,stack:d}};b.deserializeError=a=>{const b=new Error;return Object.keys(a).forEach(c=>b[c]=a[c]),b}});c(t);var u=t.deserializeError,v=t.serializeError,w=d(function(a,b){Object.defineProperty(b,"__esModule",{value:!0}),b.default=void 0;b.default=(a,b,c)=>{const d=a.localName,f=a.local,g=a.remote,h=a.originForSending,i=a.originForReceiving;let j=!1;c(`${d}: Connecting call receiver`);const k=a=>{if(a.source!==g||a.data.penpal!==e.CALL)return;if(a.origin!==i)return void c(`${d} received message from origin ${a.origin} which did not match expected origin ${i}`);const f=a.data,k=f.methodName,l=f.args,m=f.id;c(`${d}: Received ${k}() call`);const n=a=>b=>{if(c(`${d}: Sending ${k}() reply`),j)return void c(`${d}: Unable to send ${k}() reply due to destroyed connection`);const f={penpal:e.REPLY,id:m,resolution:a,returnValue:b};a===e.REJECTED&&b instanceof Error&&(f.returnValue=(0,t.serializeError)(b),f.returnValueIsError=!0);try{g.postMessage(f,h)}catch(a){throw a.name===e.DATA_CLONE_ERROR&&g.postMessage({penpal:e.REPLY,id:m,resolution:e.REJECTED,returnValue:(0,t.serializeError)(a),returnValueIsError:!0},h),a}};new Promise(a=>a(b[k].apply(b,l))).then(n(e.FULFILLED),n(e.REJECTED))};return f.addEventListener(e.MESSAGE,k),()=>{j=!0,f.removeEventListener(e.MESSAGE,k)}},a.exports=b.default});c(w);var x=d(function(a,b){Object.defineProperty(b,"__esModule",{value:!0}),b.default=void 0;let c=0;var d=()=>++c;b.default=d,a.exports=b.default});c(x);var y=d(function(a,b){Object.defineProperty(b,"__esModule",{value:!0}),b.default=void 0;var c=function(a){return a&&a.__esModule?a:{default:a}}(x);b.default=(a,b,d,f,g)=>{const h=b.localName,i=b.local,j=b.remote,k=b.originForSending,l=b.originForReceiving;let m=!1;g(`${h}: Connecting call sender`);const o=a=>function(){for(var b=arguments.length,d=Array(b),o=0;o<b;o++)d[o]=arguments[o];g(`${h}: Sending ${a}() call`);let p;try{j.closed&&(p=!0)}catch(a){p=!0}if(p&&f(),m){const b=new Error(`Unable to send ${a}() call due `+`to destroyed connection`);throw b.code=n.ERR_CONNECTION_DESTROYED,b}return new Promise((b,f)=>{const m=(0,c.default)(),n=c=>{if(c.source!==j||c.data.penpal!==e.REPLY||c.data.id!==m)return;if(c.origin!==l)return void g(`${h} received message from origin ${c.origin} which did not match expected origin ${l}`);g(`${h}: Received ${a}() reply`),i.removeEventListener(e.MESSAGE,n);let d=c.data.returnValue;c.data.returnValueIsError&&(d=(0,t.deserializeError)(d)),(c.data.resolution===e.FULFILLED?b:f)(d)};i.addEventListener(e.MESSAGE,n),j.postMessage({penpal:e.CALL,id:m,methodName:a,args:d},k)})};return d.reduce((a,b)=>(a[b]=o(b),a),a),()=>{m=!0}},a.exports=b.default});c(y);var z=d(function(a,b){Object.defineProperty(b,"__esModule",{value:!0}),b.default=void 0;b.default=a=>function(){if(a){for(var b=arguments.length,c=Array(b),d=0;d<b;d++)c[d]=arguments[d];console.log("[Penpal]",...c)}},a.exports=b.default});c(z);var A=d(function(a,b){function c(a){return a&&a.__esModule?a:{default:a}}Object.defineProperty(b,"__esModule",{value:!0}),b.default=void 0;var d=c(s),f=c(w),g=c(y),h=c(z);b.default=function(){let a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},b=a.parentOrigin,c=void 0===b?"*":b,i=a.methods,j=void 0===i?{}:i,k=a.timeout,l=a.debug;const m=(0,h.default)(l);if(window===window.top){const a=new Error("connectToParent() must be called within an iframe");throw a.code=n.ERR_NOT_IN_IFRAME,a}const o=(0,d.default)(),p=o.destroy,q=o.onDestroy,r=window,s=r.parent,t=new Promise((a,b)=>{let d;k!==void 0&&(d=setTimeout(()=>{const a=new Error(`Connection to parent timed out after ${k}ms`);a.code=n.ERR_CONNECTION_TIMEOUT,b(a),p()},k));const h=b=>{try{clearTimeout()}catch(a){return}if(b.source!==s||b.data.penpal!==e.HANDSHAKE_REPLY)return;if("*"!==c&&c!==b.origin)return void m(`Child received handshake reply from origin ${b.origin} which did not match expected origin ${c}`);m("Child: Received handshake reply"),r.removeEventListener(e.MESSAGE,h);const i={localName:"Child",local:r,remote:s,originForSending:"null"===b.origin?"*":b.origin,originForReceiving:b.origin},k={},l=(0,f.default)(i,j,m);q(l);const n=(0,g.default)(k,i,b.data.methodNames,p,m);q(n),clearTimeout(d),a(k)};r.addEventListener(e.MESSAGE,h),q(()=>{r.removeEventListener(e.MESSAGE,h);const a=new Error("Connection destroyed");a.code=n.ERR_CONNECTION_DESTROYED,b(a)}),m("Child: Sending handshake"),s.postMessage({penpal:e.HANDSHAKE,methodNames:Object.keys(j)},c)});return{promise:t,destroy:p}},a.exports=b.default}),B=c(A);(a=>{const b=document.createElement("style");b.appendChild(document.createTextNode(a)),document.head.appendChild(b)})("\n  html, body {\n    background-color: transparent !important;\n  }\n");let C,D={};const E=a=>{const b=D[a];if(b)return b.bind(D);throw new Error("Unable to call ".concat(a," on the extension. The extension must register a ").concat(a," function using extensionBridge.register()."))},F=(a,b)=>function(){for(var c=arguments.length,d=Array(c),e=0;e<c;e++)d[e]=arguments[e];let f;return"function"==typeof d[0]&&(f=d.shift(),console.warn("Passing a callback to extensionBridge."+a+"() has been deprecated. The method now returns a promise that should be used instead.")),C.then(c=>{if(c[a])return c[a](...d);throw new Error("An error occurred while opening ".concat(b,". The shared view is unavailable."))}).then(a=>(f&&f(a),a))};C=B({methods:{init:function(){E("init")(...arguments)},validate:function(){return Promise.resolve(E("validate")(...arguments)).then(a=>{if("boolean"!=typeof a)throw new Error("The extension attempted to return a non-boolean value from validate: ".concat(a));return a})},getSettings:function(){return Promise.resolve(E("getSettings")(...arguments)).then(a=>{if("object"!=typeof a)throw new Error("The extension attempted to return a non-object value from getSettings: "+a);return a})}}}).promise;const G={openCodeEditor:F("openCodeEditor","code editor"),openDataElementSelector:F("openDataElementSelector","data element selector"),openRegexTester:F("openRegexTester","regex tester"),register(a){D=b({},a),C.then(a=>a.extensionRegistered())}};window.addEventListener("focus",()=>{C.then(a=>a.markAsDirty())});const H=a=>{Promise.resolve(G[a.methodName](...a.args)).then(a.resolve,a.reject)},I=window.extensionBridge._callQueue;for(;I.length;)H(I.shift());I.push=H})();
